package com.altran.solution.parser;

import com.altran.solution.TestParent;
import com.altran.solution.model.ResultsDTO;
import org.json.simple.parser.ParseException;
import org.junit.Before;
import org.junit.Test;

import static org.junit.Assert.assertEquals;

public class ResultParserTest extends TestParent {

    private String json;
    private String invalidJson;

    @Before
    public void setUp() throws Exception {
        invalidJson = "inv√°lido";
        json = "{     \"help\":\"http://opendata-ajuntament.barcelona.cat/data/api/3/action/help_show?name=package_search\",   \"success\":true,   \"result\":{        \"count\":469,      \"sort\":\"fecha_publicacion desc\",      \"facets\":{        },      \"results\":[          {              \"notes_translated\":{                 \"ca\":\"Informaci\\u00f3 sobre la qualitat de l'aire de la ciutat de Barcelona. Es mostren dades de la mesura de O3 (Oz\\u00f3 troposf\\u00e8ric), NO2 (Di\\u00f2xid de nitrogen) i PM10 (Part\\u00edcules en suspensi\\u00f3) . El dataset  mostra  tamb\\u00e9 les dades  de totes les estacions de Catalunya.\",               \"en\":\"Air quality information of the city of Barcelona. Mesure data are showed of O3 (tropospheric Ozone), NO2 (Nitrogen dioxide), PM10 (Suspended particles). The dataset also shows data of all Catalonia stations.\",               \"es\":\"Informaci\\u00f3n sobre la calidad del aire de la ciudad de Barcelona. Se muestran datos de las medidas de O3 (Ozono troposf\\u00e9rico), NO2 (Di\\u00f3xido de nitr\\u00f3geno) y PM10 (Part\\u00edculas en suspensi\\u00f3n). El dataset  muestra tambi\\u00e9n  los datos de todas las estaciones de Catalu\\u00f1a.\"            },            \"geolocation\":\"Yes_no_map_view\",            \"code\":\"qualitat_aire_detall\",            \"url_tornada\":{                 \"ca\":\"http://mediambient.gencat.cat/ca/05_ambits_dactuacio/atmosfera/qualitat_de_laire/\",               \"en\":\"http://mediambient.gencat.cat/ca/05_ambits_dactuacio/atmosfera/qualitat_de_laire/\",               \"es\":\"http://mediambient.gencat.cat/es/05_ambits_dactuacio/atmosfera/qualitat_de_laire/\"            },            \"dataset_fields_description\":\"La font origen  de la 'Qualitat de l'aire a la ciutat de Barcelona'  \\u00e9s la Direcci\\u00f3 General de Qualitat Ambiental i Canvi Clim\\u00e0tic de la Generalitat de Catalunya  i  els 3 nivells de la dada qualitativa, que al fitxer s\\u2019anomenen qualitat_01, qualitat_02 i qualitat_03  \\u00e9s troben detallats a __ [Qu\\u00e8 \\u00e9s l'\\u00cdndex Catal\\u00e0 de Qualitat de l'Aire?](http://mediambient.gencat.cat/ca/05_ambits_dactuacio/atmosfera/qualitat_de_laire/avaluacio/icqa/que_es_lindex_catala_de_qualitat_de_laire/index.html)__\\r\\n\\r\\nL'Ajuntament de Barcelona,  ara facilitador d'aquestes dades t\\u00e9 establert una classificaci\\u00f3 en 5 nivells que pot \\u00e9sser consultada a __ [Classificaci\\u00f3 de l\\u2019Estat de la Qualitat de l\\u2019Aire de Barcelona (EQAB)     ](https://ajuntament.barcelona.cat/qualitataire/ca/classificaci-de-l-estat-de-la-qualitat-de-l-aire-de-barcelona-eqab)__\",            \"fuente\":\"Direcci\\u00f3 General de Qualitat Ambiental i Canvi Clim\\u00e0tic de la Generalitat de Catalunya\",            \"private\":false,            \"num_tags\":6,            \"api\":\"No\",            \"frequency\":\"IMMEDIATA\",            \"update_string\":\"\",            \"id\":\"0582a266-ea06-4cc5-a219-913b22484e40\",            \"title_translated\":{                 \"ca\":\"Qualitat de l'aire de la ciutat de Barcelona\",               \"en\":\"Air quality of the city of Barcelona\",               \"es\":\"Calidad del aire de la ciudad de Barcelona\"            },            \"metadata_modified\":\"2018-06-15T11:29:26.391302\",            \"author\":\"Medi Ambient i Serveis Urbans - Ecologia Urbana\",            \"author_email\":null,            \"state\":\"active\",            \"version\":\"\",            \"observations\":\"\",            \"relationships_as_object\":[              ],            \"department\":\"Departament de Qualitat Ambiental\",            \"creator_user_id\":\"a0640e91-ca5a-4114-bd78-6c47726d80f0\",            \"type\":\"dataset\",            \"resources\":[                 {                    \"cache_last_updated\":null,                  \"package_id\":\"0582a266-ea06-4cc5-a219-913b22484e40\",                  \"datastore_active\":false,                  \"id\":\"c2032e7c-10ee-4c69-84d3-9e8caf9ca97a\",                  \"size\":null,                  \"state\":\"active\",                  \"api_access_number\":\"0\",                  \"api_access_number_absolute\":\"0\",                  \"hash\":\"\",                  \"description\":\"\",                  \"format\":\"XML\",                  \"downloads\":\"43\",                  \"mimetype_inner\":null,                  \"url_type\":null,                  \"file_volum\":\"little\",                  \"mimetype\":null,                  \"cache_url\":null,                  \"name\":\"qualitataire.xml\",                  \"created\":\"2018-05-23T15:10:28.678748\",                  \"url\":\"http://www.gencat.cat/mediamb/qaire/mapes_qualitat_aire_catalunya/qualitatairecatalunya/qualitatairecatalunya.xml\",                  \"downloads_absolute\":\"65\",                  \"map_visualization_res\":\"none\",                  \"qa\":\"{'updated': '2018-06-25T02:07:52.712416', 'openness_score': 3, 'archival_timestamp': None, 'format': u'XML', 'created': '2018-05-24T02:07:27.871534', 'resource_timestamp': None, 'openness_score_reason': u'This file had not been downloaded at the time of scoring it. URL extension \\\"xml\\\" relates to format \\\"XML\\\" and receives score: 3.'}\",                  \"last_modified\":null,                  \"position\":0,                  \"revision_id\":\"455ee2b9-d897-4dd0-8519-4655e1cd10a7\",                  \"resource_type\":null               }            ],            \"num_resources\":1,            \"tags\":[                 {                    \"vocabulary_id\":null,                  \"state\":\"active\",                  \"display_name\":\"Aire\",                  \"id\":\"07966813-9180-4a24-94f1-659562af918d\",                  \"name\":\"Aire\"               },               {                    \"vocabulary_id\":null,                  \"state\":\"active\",                  \"display_name\":\"Medi ambient\",                  \"id\":\"53dd26cc-fd95-4780-a71c-744b717a5458\",                  \"name\":\"Medi ambient\"               },               {                    \"vocabulary_id\":null,                  \"state\":\"active\",                  \"display_name\":\"NO2\",                  \"id\":\"a715eaed-eb57-48ea-aaee-4101fb1e8f34\",                  \"name\":\"NO2\"               },               {                    \"vocabulary_id\":null,                  \"state\":\"active\",                  \"display_name\":\"O3\",                  \"id\":\"50705c69-8dfe-456b-a277-1bc0bb720312\",                  \"name\":\"O3\"               },               {                    \"vocabulary_id\":null,                  \"state\":\"active\",                  \"display_name\":\"PM10\",                  \"id\":\"181a3673-0614-4d20-9500-197b26c5a40a\",                  \"name\":\"PM10\"               },               {                    \"vocabulary_id\":null,                  \"state\":\"active\",                  \"display_name\":\"Qualitat\",                  \"id\":\"35967a8c-a288-4207-8ef5-da8eba3520a8\",                  \"name\":\"Qualitat\"               }            ],            \"fecha_publicacion\":\"2018-06-15\",            \"load_type\":\"link_extern\",            \"groups\":[              ],            \"license_id\":\"CC-BY-4.0\",            \"relationships_as_subject\":[              ],            \"license_title\":\"Creative Commons Attribution 4.0\",            \"organization\":{                 \"code\":\"medi-ambient\",               \"display_name\":\"Medi ambient\",               \"description\":\"Environment\",               \"parent\":{                    \"code\":\"entorn-urba\",                  \"display_name\":\"Ciutat i serveis\",                  \"description\":\"Urban environment\",                  \"created\":\"2017-01-24T16:55:08.867299\",                  \"package_count\":0,                  \"image_display_url\":\"http://opendata-ajuntament.barcelona.cat/data/uploads/group/bcn-icon2-ciutat-i-serveis\",                  \"description_translated\":{                       \"ca\":\"Ciutat i serveis\",                     \"en\":\"Urban environment\",                     \"es\":\"Ciudad y servicios\"                  },                  \"name\":\"entorn-urba\",                  \"is_organization\":true,                  \"state\":\"active\",                  \"image_url\":\"bcn-icon2-ciutat-i-serveis\",                  \"groups\":[                    ],                  \"type\":\"organization\",                  \"title\":\"Urban environment\",                  \"revision_id\":\"effe3c8f-e810-4d94-b6a8-3e57540c0802\",                  \"title_translated\":{                       \"ca\":\"Ciutat i serveis\",                     \"en\":\"Urban environment\",                     \"es\":\"Ciudad y servicios\"                  },                  \"num_followers\":0,                  \"id\":\"d80eb926-faec-4e14-98b9-8c3f0d295977\",                  \"approval_status\":\"approved\"               },               \"created\":\"2017-01-24T16:55:06.174823\",               \"package_count\":17,               \"image_display_url\":\"http://opendata-ajuntament.barcelona.cat/data/uploads/group/bcn-icon-medi-ambient\",               \"tematica_nti\":\"medio-ambiente\",               \"description_translated\":{                    \"ca\":\"Medi ambient\",                  \"en\":\"Environment\",                  \"es\":\"Medio ambiente\"               },               \"name\":\"medi-ambient\",               \"is_organization\":true,               \"state\":\"active\",               \"image_url\":\"bcn-icon-medi-ambient\",               \"groups\":[                    {                       \"capacity\":\"public\",                     \"name\":\"entorn-urba\"                  }               ],               \"type\":\"organization\",               \"title\":\"Environment\",               \"revision_id\":\"1a603339-4fe4-44b9-ac60-13395cfc79a0\",               \"title_translated\":{                    \"ca\":\"Medi ambient\",                  \"en\":\"Environment\",                  \"es\":\"Medio ambiente\"               },               \"num_followers\":0,               \"id\":\"c711e03a-e97d-4572-917e-7ca747ae541d\",               \"approval_status\":\"approved\"            },            \"name\":\"qualitat-aire-detall-bcn\",            \"isopen\":true,            \"url\":null,            \"notes\":\"Air quality information of the city of Barcelona. Mesure data are showed of O3 (tropospheric Ozone), NO2 (Nitrogen dioxide), PM10 (Suspended particles). The dataset also shows data of all Catalonia stations.\",            \"owner_org\":\"c711e03a-e97d-4572-917e-7ca747ae541d\",            \"tag\":\"Aire,Qualitat,Medi ambient,O3,NO2,PM10\",            \"license_url\":\"https://creativecommons.org/licenses/by/4.0/\",            \"historical\":\"No\",            \"title\":\"Air quality of the city of Barcelona\",            \"revision_id\":\"990c32a1-1351-4b72-9271-2bb3b04aa876\",            \"extras\":[                 {                    \"key\":\"01.nom_cabina\",                  \"value\":\"Nom de l'estaci\\u00f3/cabina. Veure __ [Estacions de mesura de la qualitat de l\\u2019aire de la ciutat de Barcelona]( http://opendata-ajuntament.barcelona.cat/data/ca/dataset/qualitat-aire-estacions-bcn)__\"               },               {                    \"key\":\"02.qualitat_aire\",                  \"value\":\"Qualitat de l'Aire: Bona, Regular o Pobra\"               },               {                    \"key\":\"03.codi_dtes\",                  \"value\":\"Codi de l'estaci\\u00f3/cabina. Veure __ [Estacions de mesura de la qualitat de l\\u2019aire de la ciutat de Barcelona]( http://opendata-ajuntament.barcelona.cat/data/ca/dataset/qualitat-aire-estacions-bcn)__\"               },               {                    \"key\":\"04.zqa\",                  \"value\":\"Codi de la zona de qualitat de l'aire on est\\u00e0 situada l'estaci\\u00f3/cabina\"               },               {                    \"key\":\"05.codi_eoi\",                  \"value\":\"Codi europeu per identificar l'estaci\\u00f3/cabina\"               },               {                    \"key\":\"06.longitud\",                  \"value\":\"Longitud\"               },               {                    \"key\":\"07.latitut\",                  \"value\":\"Latitud\"               },               {                    \"key\":\"08.hora_o3\",                  \"value\":\"Hora de la mesura de l'Oz\\u00f3 troposf\\u00e8ric (interval d'una hora)\"               },               {                    \"key\":\"09.qualitat_o3\",                  \"value\":\"Qualitat de l'Oz\\u00f3 troposf\\u00e8ric\"               },               {                    \"key\":\"10.valor_o3\",                  \"value\":\"Mitjana del valor rebut durant una hora de l'Oz\\u00f3 troposf\\u00e8ric (quan s'indica les 11:00 vols dir que la mesura s'ha fet de les 11:00 a les 12:00 hores)\"               },               {                    \"key\":\"11.hora_no2\",                  \"value\":\"Hora de la mesura del Di\\u00f2xid de Nitrogen (interval d'una hora)\"               },               {                    \"key\":\"12.qualitat_no2\",                  \"value\":\"Qualitat del Di\\u00f2xid de Nitrogen\"               },               {                    \"key\":\"13.valor_no2\",                  \"value\":\"Mitjana del valor rebut durant una hora del Di\\u00f2xid de Nitrogen (quan s'indica les 11:00 vols dir que la mesura s'ha fet de les 11:00 a les 12:00 hores)\"               },               {                    \"key\":\"14.hora_pm10\",                  \"value\":\"Hora de la mesura de les part\\u00edcules en suspensi\\u00f3 PM10 (interval d'una hora)\"               },               {                    \"key\":\"15.qualitat_pm10\",                  \"value\":\"Qualitat de les part\\u00edcules en suspensi\\u00f3 PM10: Bona, Regular o Pobra\"               },               {                    \"key\":\"16.valor_pm10\",                  \"value\":\"Mitjana del valor rebut durant una hora de les part\\u00edcules en suspensi\\u00f3 PM10 (quan s'indica les 11:00 vols dir que la mesura s'ha fet de les 11:00 a les 12:00 hores)\"               }            ]        }],\"search_facets\":{}}}";
        createExpectedResults();
    }

    @Test
    public void parseFromJsonTest() throws ParseException {
        ResultsDTO result = ResultParser.parseFromJson(json, "ca");
        assertEquals(1, result.getResults().size());
        assertEquals(expected.getCode(), result.getResults().get(0).getCode());
        assertEquals(expected.getUrl(), result.getResults().get(0).getUrl());
        assertEquals(expected.getDescription(), result.getResults().get(0).getDescription());
        assertEquals(expected.getOrganization().getCode(), result.getResults().get(0).getOrganization().getCode());
    }

    @Test(expected = ParseException.class)
    public void parseInvalidJsonTest() throws ParseException {
        ResultsDTO result = ResultParser.parseFromJson(invalidJson, "ca");
    }
}